#!/bin/bash
# gProfiler plus Module 3
cd /opt/3_gprofiler_plus
set -euo pipefail

if [ $# -lt 2 ]; then
	printf "Usage: %s <ids_map_file> <species> [gprofiler_dbs]\n" "$0"
	exit 1
fi

input_file="/data/$1"
species="$2"
gprofiler_dbs="${3:-}"

results_dir="results"
rm -rf "$results_dir"
mkdir -p "$results_dir"

if [ ! -f "${input_file}" ]; then
	printf "Error: Input IDs map file '%s' not found.\n" "$input_file"
	exit 1
fi

gmt_file="${species}_gProfiler_annotations.gmt"
if [ ! -f "/data/${gmt_file}" ]; then
	./genes_sets_species.sh "${species}"
	cp "$gmt_file" /data 2>/dev/null
else
	printf "g:Profiler annotations file found for %s.\n" "$species"
fi

# curl
./request_curl.sh "${input_file}" "${species}" "${gprofiler_dbs}"	#output: raw_output
raw_out="raw_output"
# process
./process_output.sh "${raw_out}"	# Output: short and long results files
# terms annots
./get_term_genes.sh "${input_file}" "/data/${gmt_file}"

# organize results
for file in *_results.csv; do
	[[ ! -f "$file" ]] && continue

	line_count=$(wc -l < "$file")
	if (( line_count <= 1 )); then
		printf "No statistically significant results in %s\n" "$file"
	fi
	cp "$file" "$results_dir/"
	case "$file" in
		short_results.csv) src_col=4 ;;
		long_results.csv)  src_col=10 ;;
		terms_annotations_results.csv) src_col=3 ;;
		*) continue ;;
	esac
	# split to source dirs
	header=$(head -n 1 "$file")
	mapfile -t sources < <(tail -n +2 "$file" | awk -F',' -v col="$src_col" '{print $col}' | sort -u)
	for src in "${sources[@]}"; do
		[[ -z "$src" ]] && continue
		mkdir -p "$results_dir/$src"
		{
			echo "$header"
			awk -F',' -v col="$src_col" -v val="$src" '$col == val' "$file"
		} > "$results_dir/$src/${src}_$file"
	done
done

mv "${results_dir}" /data
rm *_results.csv
